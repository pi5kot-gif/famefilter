<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>FameFilter – Person</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <!-- SEO defaults (JS je přepíše podle slug) -->
  <meta name="description" content="Latest celebrity news on FameFilter." />
  <meta name="keywords" content="celebrity news, famefilter" />
  <link rel="canonical" href="https://famefilter.com/person.html" />

  <!-- Open Graph / Twitter -->
  <meta property="og:type" content="website" />
  <meta property="og:site_name" content="FameFilter" />
  <meta property="og:title" content="FameFilter – Person" />
  <meta property="og:description" content="Latest celebrity news on FameFilter." />
  <meta property="og:url" content="https://famefilter.com/person.html" />
  <meta property="og:image" content="https://famefilter.com/assets/og-default.jpg" />
  <meta name="twitter:card" content="summary_large_image" />
  <meta name="twitter:title" content="FameFilter – Person" />
  <meta name="twitter:description" content="Latest celebrity news on FameFilter." />
  <meta name="twitter:image" content="https://famefilter.com/assets/og-default.jpg" />

  <!-- Favicons -->
  <link rel="icon" href="/favicon.ico" sizes="any">
  <link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png">
  <link rel="icon" type="image/png" sizes="48x48" href="/favicon-48x48.png">
  <link rel="icon" type="image/png" sizes="96x96" href="/favicon-96x96.png">
  <link rel="icon" type="image/png" sizes="192x192" href="/favicon-192x192.png">
  <link rel="icon" type="image/png" sizes="512x512" href="/favicon-512x512.png">
  <link rel="apple-touch-icon" sizes="180x180" href="/favicon-180x180.png">
  <link rel="manifest" href="/site.webmanifest">
  <meta name="theme-color" content="#000000">

  <style>
    :root { color-scheme: dark; }
    * { box-sizing: border-box; }
    body { margin:0; background:#000; color:#fff; font-family: system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif; }

    .hero{
      display:flex; flex-direction:column; align-items:center; justify-content:center; text-align:center;
      height:auto; padding:24px 12px; border-bottom:1px solid #1a1a1a;
    }
    /* Sjednoceno s index/credits */
    .brand{
      font-size: clamp(36px, 6vw, 56px);
      line-height: 1.1;
      font-weight: 800;
      text-transform: uppercase;
      letter-spacing: 2px;
      margin: 0;
      word-break: break-word;
    }
    .brand .accent{ color:#8ab4ff; }
    .hero p{
      margin:10px 0 0; color:#ccc; font-weight:600; letter-spacing:2px;
      text-transform:uppercase; font-size: clamp(16px, 2.2vw, 20px); line-height:1.2;
    }

    .wrap { max-width:900px; margin:0 auto; padding:20px 16px; min-height:60vh; position: relative; }

    .item { padding:16px 0; border-bottom:1px solid #1a1a1a; }
    .src  { color:#aaa; font-size:13px; margin-top:6px; }
    a { color:#8ab4ff; text-decoration:none; }
    a:hover { text-decoration:underline; }
    .empty { color:#aaa; padding:24px 0; text-align:center; }

    /* Loader */
    .loader-wrap{ position:absolute; inset:0; display:grid; place-items:center; width:100%; text-align:center; }
    .loader-inner{ display:flex; flex-direction:column; align-items:center; gap:12px; }
    .spinner{ width:48px; height:48px; border-radius:50%; border:4px solid #222; border-top-color:#8ab4ff; animation: spin .8s linear infinite; }
    .loader-text{ color:#ccc; font-size:14px; }
    @keyframes spin { to { transform: rotate(360deg); } }
    .visually-hidden{ position:absolute; width:1px; height:1px; padding:0; margin:-1px; overflow:hidden; clip:rect(0,0,0,0); white-space:nowrap; border:0; }

    footer{ text-align:center; padding:16px; border-top:1px solid #1a1a1a; margin-top:20px; }
    .btn{ display:inline-block; padding:10px 14px; border-radius:10px; border:1px solid #2a2a2a; background:#111; color:#8ab4ff; text-decoration:none; font-weight:600; transition:transform .15s ease, border-color .15s ease; }
    .btn:hover{ transform:translateY(-2px); border-color:#444; }
  </style>

  <!-- Google tag (gtag.js) -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=G-Q3QCS3QKWZ"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());
    gtag('config', 'G-Q3QCS3QKWZ');
  </script>
</head>
<body>
  <header class="hero">
    <h1 class="brand">Fame<span class="accent">Filter</span></h1>
    <p id="title">News</p>
  </header>

  <div class="wrap">
    <div id="loader" class="loader-wrap" role="status" aria-live="polite" aria-busy="true">
      <div class="loader-inner">
        <div class="spinner" aria-hidden="true"></div>
        <div class="loader-text" id="loader-text">Please wait…</div>
        <span class="visually-hidden">Loading…</span>
      </div>
    </div>
    <div id="list" style="display:none;"></div>
  </div>

  <footer>
    <a class="btn" href="index.html">Home</a>
  </footer>

  <script>
    /* ---------- Konfigurace ---------- */
    const PROXY_BASE = "https://proxy.famefilter.com/proxy";
    const ProxyURL = (PROXY_BASE && PROXY_BASE.startsWith("http")) ? PROXY_BASE : "";
    const HAVE_PROXY = !!ProxyURL;

    const slug = new URLSearchParams(location.search).get("slug") || "";
    /* Abecedně */
    const NAMES = {
      "ariana-grande":"Ariana Grande",
      "cristiano-ronaldo":"Cristiano Ronaldo",
      "dua-lipa":"Dua Lipa",
      "katy-perry":"Katy Perry",
      "kim-kardashian":"Kim Kardashian",
      "margot-robbie":"Margot Robbie",
      "rihanna":"Rihanna",
      "scarlett-johansson":"Scarlett Johansson",
      "selena-gomez":"Selena Gomez",
      "taylor-swift":"Taylor Swift"
    };

    /* ---------- SEO ---------- */
    function setSeo(name){
      const person = name || "Celebrity";
      const t = `${person} – Latest News | FameFilter`;
      const d = `Stay updated with the latest news and headlines about ${person} on FameFilter.`;
      const k = `${person} news, ${person} headlines, ${person} articles`;
      document.title = t;

      const ensure = (sel, tag, attrs={})=>{
        let el = document.querySelector(sel);
        if(!el){ el=document.createElement(tag); for(const [k,v] of Object.entries(attrs)) el.setAttribute(k,v); document.head.appendChild(el); }
        return el;
      };
      ensure('meta[name="description"]','meta',{name:'description'}).setAttribute('content', d);
      ensure('meta[name="keywords"]','meta',{name:'keywords'}).setAttribute('content', k);
      ensure('meta[property="og:title"]','meta',{property:'og:title'}).setAttribute('content', t);
      ensure('meta[property="og:description"]','meta',{property:'og:description'}).setAttribute('content', d);
      ensure('meta[property="og:url"]','meta',{property:'og:url'}).setAttribute('content', location.href);
      ensure('meta[name="twitter:title"]','meta',{name:'twitter:title'}).setAttribute('content', t);
      ensure('meta[name="twitter:description"]','meta',{name:'twitter:description'}).setAttribute('content', d);
      const can = document.querySelector('link[rel="canonical"]') || (()=>{const l=document.createElement('link');l.rel='canonical';document.head.appendChild(l);return l;})();
      can.href = location.href;
    }

    /* ---------- Utilities ---------- */
    const sleep = (ms)=>new Promise(r=>setTimeout(r, ms));
    const MAX_ITEMS = 24;
    const fmt = iso => iso ? new Date(iso).toLocaleString() : "";

    async function fetchWithTimeout(url, ms = 6000) {
      const ctrl = new AbortController();
      const t = setTimeout(() => ctrl.abort(), ms);
      try {
        return await fetch(url, {
          signal: ctrl.signal,
          cache: "no-store",
          headers: { "Accept": "application/rss+xml, application/xml, text/xml, application/json;q=0.9, */*;q=0.8" }
        });
      } finally { clearTimeout(t); }
    }

    function parseRss(xmlText){
      const doc = new DOMParser().parseFromString(xmlText, "text/xml");
      return Array.from(doc.querySelectorAll("item")).slice(0, MAX_ITEMS).map(it => {
        const title = (it.querySelector("title")?.textContent || "").trim();
        const link  = (it.querySelector("link")?.textContent || "").trim();
        const pub   = (it.querySelector("pubDate")?.textContent || "").trim();
        let source  = (it.querySelector("source")?.textContent || "").trim();
        if (!source && link) { try { source = new URL(link).hostname.replace(/^www\./,""); } catch {} }
        return { title, url: link || "#", source: source || "News", published_at: pub ? new Date(pub).toISOString() : "" };
      });
    }

    async function fetchAndParseOne(url){
      try{
        const r = await fetchWithTimeout(url, 6000);
        if (!r.ok) throw new Error(`fetch ${r.status}`);
        const ct = (r.headers.get("content-type") || "").toLowerCase();
        const xml = ct.includes("application/json") ? ((await r.json()).contents || "") : await r.text();
        const parsed = parseRss(xml);
        if (!parsed.length) throw new Error("empty feed");
        return parsed;
      }catch(err){
        console.warn("[FameFilter] fetchAndParseOne failed:", err?.message || err);
        return [];
      }
    }

    const allOriginsGet = url => `https://api.allorigins.win/get?url=${encodeURIComponent(url)}`;
    const allOriginsRaw = url => `https://api.allorigins.win/raw?url=${encodeURIComponent(url)}`;
    const viaProxy      = url => `${HAVE_PROXY ? (ProxyURL + "?url=" + encodeURIComponent(url)) : ""}`;

    async function raceMirrors(sourceUrl){
      const jobs = [
        fetchAndParseOne(allOriginsGet(sourceUrl)),
        (async()=>{ const res = await fetchWithTimeout(allOriginsRaw(sourceUrl), 6000).catch(()=>null); if(!res) return []; try { return parseRss(await res.text()); } catch { return []; } })()
      ];
      if (HAVE_PROXY) jobs.push(fetchAndParseOne(viaProxy(sourceUrl)));

      const results = await Promise.allSettled(jobs);
      for (const r of results) {
        const arr = r.status === "fulfilled" ? r.value : [];
        if (Array.isArray(arr) && arr.length) return arr;
      }
      return [];
    }

    function dedupeSort(items){
      const seen = new Set();
      return items.filter(x => {
        const k = (x.title||"").toLowerCase();
        if (seen.has(k)) return false; seen.add(k); return true;
      }).sort((a,b)=>new Date(b.published_at)-new Date(a.published_at));
    }

    /* ---------- Dotazy ---------- */
    function buildQueries(name){
      const quoted = `"${name}"`;
      return [
        `${quoted} when:90d`,
        `${name} when:90d`,
        `${quoted}`,
        `${name}`
      ];
    }
    function googleNewsRssFromQuery(q, hl="en-US", gl="US", ceid="US:en"){
      return `https://news.google.com/rss/search?q=${encodeURIComponent(q)}&hl=${hl}&gl=${gl}&ceid=${ceid}`;
    }

    async function fetchLiveWithFallback(name){
      const queries = buildQueries(name);
      const locales = [
        {hl:"en-US", gl:"US", ceid:"US:en"},
        {hl:"en-GB", gl:"GB", ceid:"GB:en"},
        {hl:"en-CA", gl:"CA", ceid:"CA:en"}
      ];

      for (const q of queries) {
        for (const loc of locales) {
          const rssUrl = googleNewsRssFromQuery(q, loc.hl, loc.gl, loc.ceid);
          const items = await raceMirrors(rssUrl);
          const cleaned = dedupeSort(items);
          if (cleaned.length) return cleaned;
          await sleep(250);
        }
      }
      return [];
    }

    /* ---------- Render ---------- */
    function render(listEl, items){
      listEl.innerHTML = items.map(x => `
        <div class="item">
          <a href="${x.url}" target="_blank" rel="noopener"><strong>${x.title}</strong></a>
          <div class="src">${x.source ? x.source + " • " : ""}${fmt(x.published_at)}</div>
        </div>
      `).join("");
    }

    /* ---------- Load ---------- */
    async function load(){
      const prettyFromSlug = s => s.replace(/-/g," ").replace(/\b\w/g, c => c.toUpperCase());
      const name = NAMES[slug] || prettyFromSlug(slug);
      setSeo(name);
      document.getElementById("title").textContent = name ? `${name} – News` : "News";

      const listEl = document.getElementById("list");
      const loaderEl = document.getElementById("loader");
      const loaderTx = document.getElementById("loader-text");

      loaderEl.style.display = "block";
      listEl.style.display = "none";

      let items = [];

      try {
        const resp = await fetch(`news/${slug}.json?ts=${Date.now()}`, { cache: "no-store" });
        if (resp.ok) {
          const data = await resp.json();
          items = Array.isArray(data.items) ? data.items : [];
          console.info(`[FameFilter] Local JSON: news/${slug}.json (${items.length})`);
        }
      } catch (e) {
        console.warn(`[FameFilter] Local JSON failed:`, e?.message || e);
      }

      if (!items.length) {
        loaderTx.textContent = "Loading live news…";
        items = await fetchLiveWithFallback(name);
        console.info(`[FameFilter] Live RSS used (${items.length})`);
      }

      loaderEl.style.display = "none";
      listEl.style.display = "block";

      if (!items.length) {
        listEl.innerHTML = `<div class="empty">No recent news found for <strong>${name}</strong> (last 90 days).<br>Please try again later.</div>`;
        return;
      }
      render(listEl, items);
    }

    load();
  </script>
</body>
</html>
