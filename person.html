<script>
  const slug = new URLSearchParams(location.search).get("slug") || "";

  const NAMES = {
    "taylor-swift":"Taylor Swift",
    "rihanna":"Rihanna",
    "cristiano-ronaldo":"Cristiano Ronaldo",
    "selena-gomez":"Selena Gomez",
    "kim-kardashian":"Kim Kardashian",
    "dua-lipa":"Dua Lipa",
    "ariana-grande":"Ariana Grande",
    "scarlett-johansson":"Scarlett Johansson",
    "katy-perry":"Katy Perry",
    "margot-robbie":"Margot Robbie"
  };

  // Fallback demo data
  const DEMO = {
    "cristiano-ronaldo": [
      {title:"Ronaldo scores stunning free-kick", source:"ESPN", url:"#", published_at:"2025-08-29T12:30:00Z"},
      {title:"Al Nassr extend unbeaten run", source:"BBC Sport", url:"#", published_at:"2025-08-28T20:10:00Z"}
    ],
    "taylor-swift": [
      {title:"Taylor Swift teases new single", source:"Billboard", url:"#", published_at:"2025-08-28T18:00:00Z"}
    ]
  };

  // Google News RSS (USA/EN) – posledních 7 dní
  function googleNewsRss(name) {
    const q = encodeURIComponent(`${name} when:7d`);
    return `https://news.google.com/rss/search?q=${q}&hl=en-US&gl=US&ceid=US:en`;
  }

  // Přes veřejný proxy, aby fungoval CORS v prohlížeči
  function proxied(url) {
    // „raw“ vrátí čisté XML bez JSON obalu
    return `https://api.allorigins.win/raw?url=${encodeURIComponent(url)}`;
  }

  // Hezký formát času
  const fmt = iso => new Date(iso).toLocaleString();

  // Parsování RSS XML -> naše položky
  function parseRss(xmlText) {
    const doc = new DOMParser().parseFromString(xmlText, "text/xml");
    const items = Array.from(doc.querySelectorAll("item")).slice(0, 30);
    return items.map(it => {
      const title = it.querySelector("title")?.textContent?.trim() || "Untitled";
      const link  = it.querySelector("link")?.textContent?.trim() || "#";
      const pub   = it.querySelector("pubDate")?.textContent?.trim();
      const src   = it.querySelector("source")?.textContent?.trim() || "Google News";
      // pubDate na ISO (když to jde)
      let published_at = "";
      try { published_at = new Date(pub).toISOString(); } catch(e){}
      return { title, url: link, source: src, published_at };
    });
  }

  async function load() {
    const name = NAMES[slug] || slug.replace(/-/g," ").replace(/\b\w/g, c => c.toUpperCase());
    document.getElementById("title").textContent = name ? `${name} – News` : "News";

    let items = [];

    try {
      const rssUrl = googleNewsRss(name);
      const res = await fetch(proxied(rssUrl), { cache: "no-store" });
      if (!res.ok) throw new Error("RSS fetch failed");
      const xml = await res.text();
      items = parseRss(xml);
    } catch (e) {
      // fallback na demo
      items = DEMO[slug] || [];
    }

    const list = document.getElementById("list");
    if (!items.length) {
      list.innerHTML = `<div class="empty">No recent links yet.</div>`;
      return;
    }

    list.innerHTML = items.map(x => `
      <div class="item">
        <a href="${x.url}" target="_blank" rel="noopener"><strong>${x.title}</strong></a>
        <div class="src">${x.source ? x.source + " • " : ""}${x.published_at ? fmt(x.published_at) : ""}</div>
      </div>
    `).join("");
  }

  load();
</script>
